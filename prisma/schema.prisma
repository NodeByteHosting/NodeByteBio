// This is your Prisma schema file for NodeByte authentication
// Docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// USER & AUTH MODELS
// ============================================================================

// User model for authentication
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?
  username      String?
  firstName     String?
  lastName      String?
  
  roles         Role[]    @default([MEMBER])
  isPterodactylAdmin Boolean @default(false) // Can manage Pterodactyl panel
  isVirtfusionAdmin  Boolean @default(false) // Can manage Virtfusion panel
  isSystemAdmin      Boolean @default(false) // Full system access (billing, users, settings)
  
  // Panel IDs - support multiple panels
  pterodactylId Int?      // Link to Pterodactyl panel user ID
  virtfusionId  Int?      // Link to Virtfusion panel user ID
  
  // Migration status
  isMigrated    Boolean   @default(false) // True once user registers/sets password on our site
  
  // Email verification
  emailVerified DateTime?
  
  // Account status
  isActive      Boolean   @default(true)
  
  // Profile & billing
  avatarUrl     String?
  companyName   String?
  phoneNumber   String?
  billingEmail  String?   // May differ from primary email
  
  // Billing & account
  accountBalance Decimal  @default(0) @db.Decimal(10, 2) // Account credit balance
  accountStatus  String   @default("active") // active, suspended, cancelled
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  lastSyncedAt  DateTime? // Last time data was synced from panels
  
  // Relations
  sessions      Session[]
  passwordResetToken PasswordResetToken? // Password reset token
  servers       Server[]  // Servers owned by this user
  discordWebhooks DiscordWebhook[] // Webhooks created by this user
  invoices      Invoice[]
  tickets       SupportTicket[]  // Support tickets created by this user
  ticketReplies SupportTicketReply[] // Replies to tickets
  products      Product[] // Products this user has created/selling
  
  @@map("users")
}

// Session model for auth tokens
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now())
  
  @@map("sessions")
}

// Password reset tokens for secure password recovery
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String   @unique
  token     String   @unique
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@map("password_reset_tokens")
}

// Verification tokens for email verification, password reset, etc.
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  type       String   @default("email") // email, password_reset, etc.
  
  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// PTERODACTYL SYNC MODELS - These mirror Pterodactyl data for local access
// ============================================================================

// Location (data center region)
model Location {
  id          Int      @id // Pterodactyl location ID
  shortCode   String   @unique
  description String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  nodes       Node[]
  
  @@map("locations")
}

// Node (physical/virtual server hosting game servers)
model Node {
  id                  Int      @id // Pterodactyl node ID
  uuid                String   @unique
  name                String
  description         String?
  fqdn                String   // Fully qualified domain name
  scheme              String   @default("https") // http or https
  behindProxy         Boolean  @default(false)
  
  // Panel type
  panelType           String   @default("pterodactyl") // pterodactyl or virtfusion
  
  // Resources
  memory              BigInt   // Total memory in MB
  memoryOverallocate  Int      @default(0) // Percentage
  disk                BigInt   // Total disk in MB
  diskOverallocate    Int      @default(0) // Percentage
  
  // Status
  isPublic            Boolean  @default(true)
  isMaintenanceMode   Boolean  @default(false)
  
  // Connection info (for internal use)
  daemonListenPort    Int      @default(8080)
  daemonSftpPort      Int      @default(2022)
  daemonBase          String   @default("/var/lib/pterodactyl/volumes")
  
  // Location relation
  locationId          Int
  location            Location @relation(fields: [locationId], references: [id])
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  allocations         Allocation[]
  servers             Server[]
  
  @@index([panelType])
  @@map("nodes")
}

// Allocation (IP:Port combination on a node)
model Allocation {
  id          Int      @id // Pterodactyl allocation ID
  ip          String
  port        Int
  alias       String?  // Optional friendly name/hostname
  notes       String?
  isAssigned  Boolean  @default(false)
  
  nodeId      Int
  node        Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  
  // Server relation (null if unassigned)
  serverId    String?
  server      Server?  @relation(fields: [serverId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([ip, port])
  @@map("allocations")
}

// Nest (category of eggs, e.g., "Minecraft", "Rust")
model Nest {
  id          Int      @id // Pterodactyl nest ID
  uuid        String   @unique
  name        String
  description String?
  author      String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  eggs        Egg[]
  
  @@map("nests")
}

// Egg (server type template, e.g., "Paper", "Vanilla", "Forge")
model Egg {
  id              Int      @id // Pterodactyl egg ID
  uuid            String   @unique
  name            String
  description     String?
  author          String?
  
  // Panel type support
  panelType       String   @default("pterodactyl") // pterodactyl, virtfusion, etc.
  
  nestId          Int
  nest            Nest     @relation(fields: [nestId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  servers         Server[]
  variables       EggVariable[]
  properties      EggProperty[] // Flexible key-value for panel-specific config
  
  @@index([panelType])
  @@map("eggs")
}

// Egg Property - Key-value store for egg-specific configurations
model EggProperty {
  id              String   @id @default(cuid())
  eggId           Int
  egg             Egg      @relation(fields: [eggId], references: [id], onDelete: Cascade)
  
  key             String   // e.g., "docker_image", "startup_command", "docker_images_json"
  value           String   // Stored as JSON if needed
  panelType       String?  // null = applies to all panels, "pterodactyl" or "virtfusion" for specific panels
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([eggId, key, panelType])
  @@index([eggId])
  @@map("egg_properties")
}

// Egg Variable (configuration options for an egg)
model EggVariable {
  id            Int      @id // Pterodactyl variable ID
  eggId         Int
  egg           Egg      @relation(fields: [eggId], references: [id], onDelete: Cascade)
  
  name          String
  description   String?
  envVariable   String   // Environment variable name
  defaultValue  String?
  userViewable  Boolean  @default(true)
  userEditable  Boolean  @default(true)
  rules         String?  // Validation rules
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  serverVariables ServerVariable[]
  
  @@map("egg_variables")
}

// ============================================================================
// SERVER MODEL - Core game server data
// ============================================================================

model Server {
  id                String   @id @default(cuid()) // Our internal ID
  pterodactylId     Int?     @unique // Pterodactyl server ID (null if virtfusion)
  virtfusionId      Int?     @unique // Virtfusion server ID (null if pterodactyl)
  uuid              String   @unique // Pterodactyl UUID
  uuidShort         String?  // Short UUID for panel URLs
  externalId        String?  @unique // External ID (e.g., billing system ID)
  
  // Panel identification
  panelType         String   @default("pterodactyl") // pterodactyl or virtfusion
  
  name              String
  description       String?
  
  // Status
  status            ServerStatus @default(INSTALLING)
  isSuspended       Boolean  @default(false)
  
  // Billing
  productId         String?  // Link to billing product
  product           Product? @relation("ServerProduct", fields: [productId], references: [id], onDelete: SetNull)
  
  // Relations
  ownerId           String
  owner             User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  nodeId            Int
  node              Node     @relation(fields: [nodeId], references: [id], onDelete: Restrict)
  
  eggId             Int?     // Optional for virtfusion
  egg               Egg?     @relation(fields: [eggId], references: [id], onDelete: SetNull)
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  installedAt       DateTime?
  lastSyncedAt      DateTime?
  
  // Related data
  allocations       Allocation[]
  variables         ServerVariable[]
  databases         ServerDatabase[]
  backups           ServerBackup[]
  properties        ServerProperty[] // Flexible key-value for specs and config
  tickets           SupportTicket[]
  
  @@index([panelType])
  @@index([ownerId])
  @@index([productId])
  @@map("servers")
}

// Server Property - Key-value store for server specs and configuration
model ServerProperty {
  id              String   @id @default(cuid())
  serverId        String
  server          Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  
  key             String   // e.g., "memory", "disk", "cpu", "swap", "io", "oom_disabled", "backup_limit"
  value           String   // Stored as string - parse as int/bool as needed
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([serverId, key])
  @@index([serverId])
  @@map("server_properties")
}

enum ServerStatus {
  INSTALLING
  INSTALL_FAILED
  SUSPENDED
  RESTORING_BACKUP
  RUNNING
  OFFLINE
  STARTING
  STOPPING
}

// Server Variable (runtime configuration)
model ServerVariable {
  id              String   @id @default(cuid())
  serverId        String
  server          Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  
  variableId      Int
  variable        EggVariable @relation(fields: [variableId], references: [id])
  
  value           String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([serverId, variableId])
  @@map("server_variables")
}

// Server Database
model ServerDatabase {
  id              Int      @id // Pterodactyl database ID
  serverId        String
  server          Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  
  name            String
  username        String
  host            String
  port            Int      @default(3306)
  maxConnections  Int      @default(0) // 0 = unlimited
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("server_databases")
}

// Server Backup
model ServerBackup {
  id              String   @id // Pterodactyl backup UUID
  serverId        String
  server          Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  
  name            String
  ignoredFiles    Json?    // Files/folders ignored in backup
  sha256Hash      String?
  bytes           BigInt   @default(0)
  
  isSuccessful    Boolean  @default(false)
  isLocked        Boolean  @default(false)
  
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("server_backups")
}

// ============================================================================
// SYNC LOG - Track synchronization history
// ============================================================================

model SyncLog {
  id          String   @id @default(cuid())
  type        String   // users, servers, nodes, etc.
  status      SyncStatus @default(PENDING)
  
  itemsTotal  Int      @default(0)
  itemsSynced Int      @default(0)
  itemsFailed Int      @default(0)
  
  error       String?
  metadata    Json?
  
  startedAt   DateTime @default(now())
  completedAt DateTime?
  
  @@map("sync_logs")
}

// ============================================================================
// BILLING & PRODUCTS - Lightweight WHMCS alternative
// ============================================================================

model Product {
  id              String   @id @default(cuid())
  name            String
  description     String?
  category        String   // game-server, vps, addon, etc.
  
  // Pricing
  basePrice       Decimal  @db.Decimal(10, 2) // Monthly price
  setupFee        Decimal  @default(0) @db.Decimal(10, 2)
  currency        String   @default("USD")
  
  // Billing
  billingCycle    String   @default("monthly") // monthly, quarterly, semiannual, annual, oneoff
  
  // Availability
  isActive        Boolean  @default(true)
  displayOrder    Int      @default(0)
  
  // Creator
  creatorId       String
  creator         User     @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  
  // Customization
  metadata        Json?    // Additional product metadata
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  servers         Server[] @relation("ServerProduct")
  invoices        InvoiceItem[]
  
  @@index([category])
  @@index([isActive])
  @@map("products")
}

model Invoice {
  id              String   @id @default(cuid())
  invoiceNumber   String   @unique
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Amounts
  subtotal        Decimal  @db.Decimal(10, 2)
  tax             Decimal  @default(0) @db.Decimal(10, 2)
  total           Decimal  @db.Decimal(10, 2)
  paid            Decimal  @default(0) @db.Decimal(10, 2)
  
  // Status
  status          String   @default("unpaid") // unpaid, partially_paid, paid, overdue, cancelled
  
  // Dates
  dueDate         DateTime?
  paidDate        DateTime?
  
  // Notes
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           InvoiceItem[]
  payments        Payment[]
  
  @@index([userId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

model InvoiceItem {
  id              String   @id @default(cuid())
  invoiceId       String
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  productId       String?
  product         Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  
  description     String
  quantity        Int      @default(1)
  unitPrice       Decimal  @db.Decimal(10, 2)
  total           Decimal  @db.Decimal(10, 2)
  
  @@map("invoice_items")
}

model Payment {
  id              String   @id @default(cuid())
  invoiceId       String
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  amount          Decimal  @db.Decimal(10, 2)
  method          String   // stripe, paypal, manual, credit, etc.
  reference       String?  // Transaction/Reference ID
  
  status          String   @default("completed") // pending, completed, failed, refunded
  notes           String?
  
  createdAt       DateTime @default(now())
  
  @@index([invoiceId])
  @@index([status])
  @@map("payments")
}

// ============================================================================
// SUPPORT TICKETS - Integrated ticket system
// ============================================================================

model SupportTicket {
  id              String   @id @default(cuid())
  ticketNumber    String   @unique
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  serverId        String?
  server          Server?  @relation(fields: [serverId], references: [id], onDelete: SetNull)
  
  // Ticket info
  subject         String
  category        String   // billing, technical, abuse, general, feature_request, etc.
  priority        String   @default("normal") // low, normal, high, urgent
  
  // Status
  status          String   @default("open") // open, pending, in_progress, resolved, closed
  
  // Assignment
  assignedToId    String?  // Admin user ID if assigned
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  resolvedAt      DateTime?
  
  // Relations
  replies         SupportTicketReply[]
  
  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([assignedToId])
  @@map("support_tickets")
}

model SupportTicketReply {
  id              String   @id @default(cuid())
  ticketId        String
  ticket          SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  message         String
  isInternal      Boolean  @default(false) // Internal note not visible to user
  
  attachments     Json?    // File attachment metadata
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([ticketId])
  @@index([userId])
  @@map("support_ticket_replies")
}

// ============================================================================
// DISCORD WEBHOOKS - Notification webhook management
// ============================================================================

model DiscordWebhook {
  id              String   @id @default(cuid())
  
  // Webhook identification
  name            String
  webhookUrl      String
  
  // Webhook categorization
  type            DiscordWebhookType
  scope           DiscordWebhookScope @default(ADMIN)
  description     String?
  
  // Owner information
  userId          String?
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Settings
  enabled         Boolean  @default(true)
  testSuccessAt   DateTime?
  
  // Metadata
  avatarUrl       String?
  metadata        Json?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([webhookUrl, userId])
  @@index([userId])
  @@index([type])
  @@index([scope])
  @@map("discord_webhooks")
}

// ============================================================================
// CONFIG - Simple key value store for all system settings
// ============================================================================

model Config {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   // Stored as JSON string
  updatedAt DateTime @updatedAt

  @@index([key])
  @@map("config")
}

// ============================================================================
// ENUMS
// ============================================================================

enum DiscordWebhookType {
  GAME_SERVER      // Game server notifications (start, stop, crash, etc.)
  VPS              // VPS/Node notifications (resource, status, etc.)
  SYSTEM           // System notifications (maintenance, updates, etc.)
  BILLING          // Billing/Account notifications
  SECURITY         // Security notifications (login attempts, etc.)
  SUPPORT          // Support/Ticket notifications
  CUSTOM           // User-defined/custom notifications
}

enum DiscordWebhookScope {
  ADMIN            // Admin-only webhook (global system notifications)
  USER             // User-specific webhook (their own server/account notifications)
  PUBLIC           // Public webhook (shared/testing)
}

enum SyncStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum Role {
  MEMBER
  PARTNER
  SPONSOR
  TECH_TEAM
  SUPPORT_TEAM
  ADMINISTRATOR
  SUPER_ADMIN
}